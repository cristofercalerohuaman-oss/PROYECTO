{% extends "base.html" %}
{% load humanize %}
{% load static %} {% block content %}

<style>
  /* Contenedor principal de acciones */
  .actions-menu {
    position: relative;
    display: inline-block;
  }

  /* Bot√≥n de 3 puntos (‚ãÆ) */
  .actions-menu-button {
    background: none;
    border: 1px solid #d1d5db; /* Borde gris claro */
    border-radius: 6px;
    padding: 2px 10px;
    font-size: 1.2rem;
    font-weight: bold;
    line-height: 1.2;
    color: #6b7280;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .actions-menu-button:hover {
    background-color: #f3f4f6; /* Fondo gris al pasar el mouse */
  }

  /* El men√∫ desplegable */
  .actions-dropdown {
    display: none; /* Oculto por defecto */
    position: absolute;
    right: 0;
    top: 100%; /* Justo debajo del bot√≥n */
    background-color: white;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    min-width: 140px; /* Ancho del men√∫ */
    z-index: 10;
    overflow: hidden; /* Para que los bordes redondeados corten los links */
  }

  /* Mostrar el men√∫ cuando tiene la clase 'active' */
  .actions-dropdown.active {
    display: block;
  }

  /* Links dentro del men√∫ */
  .actions-dropdown a {
    display: block;
    padding: 10px 16px;
    text-decoration: none;
    color: #374151; /* Texto gris oscuro */
    font-size: 0.95em;
  }
  .actions-dropdown a:hover {
    background-color: #f3f4f6; /* Fondo gris claro en el link */
  }
  
  /* Link de "Eliminar" en rojo */
  .actions-dropdown a.danger {
    color: #dc2626; /* Rojo */
  }
  .actions-dropdown a.danger:hover {
    background-color: #fef2f2; /* Fondo rojo claro */
  }

  /* Estilo para la fila con mantenimiento requerido */
  .mantenimiento-requerido-fila {
    background-color: #fff1f2 !important; /* El !important sobreescribe 'striped' */
    border-left: 4px solid #dc2626; /* Borde rojo para m√°s √©nfasis */
  }
  .mantenimiento-requerido-texto {
    color: #9f1239; 
    font-weight: bold;
  }
</style>
<div class="container mt-4">
  <h2>Listado de Veh√≠culos</h2>

  <div style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem;">
    {% if user.is_staff %}
    <a href="{% url 'vehiculos:importar_excel' %}" class="btn btn-secondary">üì• Importar</a>
    <a href="{% url 'vehiculos:agregar_vehiculo' %}" class="btn btn-primary">‚ûï Nuevo veh√≠culo</a>
    {% endif %}
  </div>

  <div class="card" style="margin-bottom: 1.5rem; padding: 1rem;">
    <form method="get" action="{% url 'vehiculos:listar_vehiculos' %}">
      <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">

        <div>
          <label for="marca" style="display: block; margin-bottom: .3rem; font-weight: 600; font-size: 0.9em; color: var(--muted);">Marca:</label>
          <select id="marca" name="marca" style="padding: 0.5rem; border-radius: 8px; border: 1px solid #e6e9ee; min-width: 150px;">
            <option value="">-- Todas --</option>
            {% for marca in marcas_disponibles %}
              {% if marca %}
              <option value="{{ marca }}" {% if marca_seleccionada == marca %}selected{% endif %}>
                {{ marca }}
              </option>
              {% endif %}
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="activo" style="display: block; margin-bottom: .3rem; font-weight: 600; font-size: 0.9em; color: var(--muted);">Estado:</label>
          <select id="activo" name="activo" style="padding: 0.5rem; border-radius: 8px; border: 1px solid #e6e9ee; min-width: 120px;">
            <option value="">-- Todos --</option>
            <option value="true" {% if activo_seleccionado == 'true' %}selected{% endif %}>Activo</option>
            <option value="false" {% if activo_seleccionado == 'false' %}selected{% endif %}>Inactivo</option>
          </select>
        </div>

        <div>
          <label for="mantenimiento" style="display: block; margin-bottom: .3rem; font-weight: 600; font-size: 0.9em; color: var(--muted);">Mantenimiento:</label>
          <select id="mantenimiento" name="mantenimiento" style="padding: 0.5rem; border-radius: 8px; border: 1px solid #e6e9ee; min-width: 120px;">
            <option value="">-- Todos --</option>
            <option value="true" {% if mantenimiento_seleccionado == 'true' %}selected{% endif %}>Requerido</option>
            <option value="false" {% if mantenimiento_seleccionado == 'false' %}selected{% endif %}>Al d√≠a</option>
          </select>
        </div>

        <div style="margin-top: 1.5rem;">
            <button type="submit" class="btn btn-secondary" style="margin-top: 0; padding: 0.5rem 0.8rem;">Filtrar</button>
            <a href="{% url 'vehiculos:listar_vehiculos' %}" class="btn btn-outline" style="margin-top: 0; padding: 0.5rem 0.8rem;">Limpiar</a>
        </div>
      </div>
    </form>
  </div>
  
  {% if vehiculos %}
    <div class="table-responsive card">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>N¬∞</th>
            <th>PLACA</th>
            <th>MARCA</th>
            <th>MODELO</th>
            <th>A√ëO</th>
            <th>KM ACTUAL</th>
            <th>PR√ìX. MANT.</th>
            <th>ESTADO</th>
            <th>ACCIONES</th> </tr>
        </thead>
        <tbody>
          {% for vehiculo in vehiculos %}
          <tr {% if vehiculo.mantenimiento_requerido %}class="mantenimiento-requerido-fila"{% endif %}>
            <td>{{ forloop.counter }}</td>
            <td>{{ vehiculo.placa }}</td>
            <td>{{ vehiculo.marca }}</td>
            <td>{{ vehiculo.modelo }}</td>
            <td>{{ vehiculo.anio|default:"-" }}</td>
            <td>{{ vehiculo.kilometraje|intcomma|default:"0" }}</td>
            <td>{{ vehiculo.km_proximo_mantenimiento|intcomma|default:"-" }}</td>
            <td>
              {% if vehiculo.mantenimiento_requerido %}
                <span class="mantenimiento-requerido-texto">Mant. Requerido</span>
              {% elif vehiculo.activo %}
                Activo
              {% else %}
                Inactivo
              {% endif %}
            </td>
            
            <td class="actions-col">
              <div class="actions-menu">
                <button class="actions-menu-button">‚ãÆ</button>
                <div class="actions-dropdown">
                  <a href="{% url 'vehiculos:detalle_vehiculo' vehiculo.pk %}">Ver</a>
                  {% if user.is_staff %}
                    <a href="{% url 'vehiculos:editar_vehiculo' vehiculo.pk %}">Editar</a>
                    <a href="{% url 'vehiculos:eliminar_vehiculo' vehiculo.pk %}" 
                       class="danger" 
                       onclick="return confirm('¬øEst√°s seguro de eliminar el veh√≠culo {{ vehiculo.placa }}?');">Eliminar</a>
                  {% endif %}
                </div>
              </div>
            </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="empty card">
      <p>No hay veh√≠culos registrados {% if marca_seleccionada or activo_seleccionado or mantenimiento_seleccionado %}que coincidan con los filtros{% endif %}.</p>
    </div>
  {% endif %}

</div>

<script>
  // Esta funci√≥n hace que el men√∫ de 3 puntos (‚ãÆ) funcione.
  document.addEventListener('click', function(e) {
    // Busca si se hizo clic en un bot√≥n de men√∫
    const menuButton = e.target.closest('.actions-menu-button');

    if (menuButton) {
      // Si se hizo clic en un bot√≥n, encuentra su men√∫ desplegable
      const dropdown = menuButton.nextElementSibling;
      // Cierra todos los dem√°s men√∫s que est√©n abiertos
      document.querySelectorAll('.actions-dropdown.active').forEach(openDropdown => {
        if (openDropdown !== dropdown) {
          openDropdown.classList.remove('active');
        }
      });
      // Abre o cierra el men√∫ actual
      dropdown.classList.toggle('active');
    } else {
      // Si se hizo clic en cualquier otro lugar de la p√°gina, cierra todos los men√∫s
      document.querySelectorAll('.actions-dropdown.active').forEach(openDropdown => {
        openDropdown.classList.remove('active');
      });
    }
  });
</script>
{% endblock %}